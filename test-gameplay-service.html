<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gameplay Service Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #000;
      color: #0f0;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1, h2 {
      color: #0ff;
      border-bottom: 2px solid #0ff;
      padding-bottom: 10px;
    }
    
    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #0f0;
      background: #001100;
    }
    
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }
    
    button:hover {
      background: #0ff;
    }
    
    button:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
    }
    
    .file-list {
      margin: 10px 0;
      padding: 10px;
      background: #000;
      border: 1px solid #0f0;
    }
    
    .file-item {
      padding: 5px;
      margin: 5px 0;
      background: #002200;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      background: #000;
      border-left: 4px solid #0ff;
    }
    
    .error {
      color: #f00;
      border-left-color: #f00;
    }
    
    .success {
      color: #0f0;
      border-left-color: #0f0;
    }
    
    .warning {
      color: #ff0;
      border-left-color: #ff0;
    }
    
    .cooldown {
      color: #f80;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>üéÆ Gameplay Service Test</h1>
  
  <div class="section">
    <h2>Possession Level</h2>
    <div id="possession-display" class="status">
      Level: <span id="possession-level">0</span> / 100
    </div>
    <button onclick="increasePossession()">Increase +10</button>
    <button onclick="decreasePossession()">Decrease -10</button>
    <button onclick="setPossession(50)">Set to 50</button>
    <button onclick="setPossession(0)">Reset to 0</button>
  </div>
  
  <div class="section">
    <h2>Cursed Files</h2>
    <div id="cursed-files" class="file-list">
      Loading...
    </div>
    <button onclick="refreshCursedFiles()">Refresh List</button>
    <button onclick="regenerateCursedFiles()">Regenerate Files</button>
  </div>
  
  <div class="section">
    <h2>Exorcism Actions</h2>
    
    <div style="margin: 15px 0;">
      <h3>Text Exorcism</h3>
      <input type="text" id="exorcism-text" placeholder="Type 'begone spirit'" style="width: 300px; padding: 8px; background: #000; color: #0f0; border: 1px solid #0f0;">
      <button onclick="performTextExorcism()">Perform Text Exorcism</button>
      <div id="text-cooldown" class="cooldown"></div>
    </div>
    
    <div style="margin: 15px 0;">
      <h3>File Exorcism</h3>
      <p>Delete cursed files from the list above (reduces possession by 8 points)</p>
      <div id="file-cooldown" class="cooldown"></div>
    </div>
  </div>
  
  <div class="section">
    <h2>Achievements</h2>
    <div id="achievements" class="status">
      No achievements unlocked yet
    </div>
    <button onclick="checkAchievements()">Check Achievements</button>
  </div>
  
  <div class="section">
    <h2>Event Log</h2>
    <div id="event-log" style="max-height: 300px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #0f0;">
    </div>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <script type="module">
    import { useAdvancedHauntingStore } from './src/stores/advancedHaunting.js'
    import { gameplayService } from './src/utils/gameplayService.js'
    import { createPinia } from 'pinia'
    
    // Initialize Pinia
    const pinia = createPinia()
    
    // Make stores and services globally available for testing
    window.advancedHaunting = useAdvancedHauntingStore(pinia)
    window.gameplayService = gameplayService
    
    // Initialize stores
    window.advancedHaunting.initialize()
    window.gameplayService.initialize()
    
    // Log function
    function log(message, type = 'info') {
      const logDiv = document.getElementById('event-log')
      const timestamp = new Date().toLocaleTimeString()
      const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0ff'
      logDiv.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${timestamp}] ${message}</div>`
      logDiv.scrollTop = logDiv.scrollHeight
    }
    
    window.log = log
    
    // Update possession display
    function updatePossessionDisplay() {
      const level = window.advancedHaunting.possessionLevel
      document.getElementById('possession-level').textContent = level
      
      const display = document.getElementById('possession-display')
      display.className = 'status'
      if (level >= 80) {
        display.classList.add('error')
      } else if (level >= 50) {
        display.classList.add('warning')
      } else {
        display.classList.add('success')
      }
    }
    
    window.updatePossessionDisplay = updatePossessionDisplay
    
    // Possession controls
    window.increasePossession = () => {
      window.advancedHaunting.increasePossession(10)
      updatePossessionDisplay()
      log('Increased possession by 10', 'warning')
    }
    
    window.decreasePossession = () => {
      window.advancedHaunting.decreasePossession(10)
      updatePossessionDisplay()
      log('Decreased possession by 10', 'success')
    }
    
    window.setPossession = (level) => {
      window.advancedHaunting.setPossessionLevel(level)
      updatePossessionDisplay()
      log(`Set possession to ${level}`, 'info')
    }
    
    // Cursed files
    window.refreshCursedFiles = () => {
      const files = window.gameplayService.getCursedFileList()
      const container = document.getElementById('cursed-files')
      
      if (files.length === 0) {
        container.innerHTML = '<div style="color: #888;">No cursed files</div>'
      } else {
        container.innerHTML = files.map(file => `
          <div class="file-item">
            <span>üìÑ ${file.name} (ID: ${file.id})</span>
            <button onclick="deleteCursedFile('${file.id}')">Delete (-${file.possessionValue})</button>
          </div>
        `).join('')
      }
      
      log(`Loaded ${files.length} cursed files`, 'info')
    }
    
    window.regenerateCursedFiles = () => {
      window.gameplayService.cursedFiles = []
      window.gameplayService.generateCursedFiles()
      window.refreshCursedFiles()
      log('Regenerated cursed files', 'success')
    }
    
    window.deleteCursedFile = (fileId) => {
      const success = window.gameplayService.deleteCursedFile(fileId)
      
      if (success) {
        log(`Deleted cursed file (ID: ${fileId})`, 'success')
        window.refreshCursedFiles()
        updatePossessionDisplay()
        updateCooldowns()
      } else {
        log('File exorcism on cooldown!', 'error')
      }
    }
    
    // Text exorcism
    window.performTextExorcism = () => {
      const input = document.getElementById('exorcism-text')
      const phrase = input.value
      
      const success = window.gameplayService.performTextExorcism(phrase)
      
      if (success) {
        log('Text exorcism successful! (-15 possession)', 'success')
        input.value = ''
        updatePossessionDisplay()
        updateCooldowns()
      } else {
        if (window.advancedHaunting.isExorcismOnCooldown('text')) {
          log('Text exorcism on cooldown!', 'error')
        } else {
          log('Incorrect phrase. Try "begone spirit"', 'warning')
        }
      }
    }
    
    // Cooldown display
    function updateCooldowns() {
      const textCooldown = window.gameplayService.getRemainingCooldown('text')
      const fileCooldown = window.gameplayService.getRemainingCooldown('file')
      
      document.getElementById('text-cooldown').textContent = 
        textCooldown > 0 ? `Cooldown: ${textCooldown}s remaining` : ''
      
      document.getElementById('file-cooldown').textContent = 
        fileCooldown > 0 ? `Cooldown: ${fileCooldown}s remaining` : ''
    }
    
    window.updateCooldowns = updateCooldowns
    
    // Update cooldowns every second
    setInterval(updateCooldowns, 1000)
    
    // Achievements
    window.checkAchievements = () => {
      window.gameplayService.checkAchievements()
      
      const achievements = Array.from(window.advancedHaunting.achievements)
      const container = document.getElementById('achievements')
      
      if (achievements.length === 0) {
        container.innerHTML = 'No achievements unlocked yet'
        container.className = 'status'
      } else {
        container.innerHTML = achievements.map(id => `üèÜ ${id.toUpperCase()}`).join('<br>')
        container.className = 'status success'
      }
      
      log('Checked achievements', 'info')
    }
    
    // Clear log
    window.clearLog = () => {
      document.getElementById('event-log').innerHTML = ''
    }
    
    // Listen for events
    window.addEventListener('cursed-file-deleted', (e) => {
      log(`Event: Cursed file deleted (${e.detail.file.name})`, 'success')
    })
    
    window.addEventListener('text-exorcism-performed', (e) => {
      log(`Event: Text exorcism performed (-${e.detail.reductionAmount})`, 'success')
    })
    
    window.addEventListener('achievement-unlocked', (e) => {
      log(`üèÜ Achievement Unlocked: ${e.detail.achievementId.toUpperCase()}`, 'success')
      window.checkAchievements()
    })
    
    // Initial setup
    updatePossessionDisplay()
    window.refreshCursedFiles()
    updateCooldowns()
    
    log('Gameplay Service Test initialized', 'success')
    log('Try deleting cursed files or typing "begone spirit" to test exorcism', 'info')
  </script>
</body>
</html>
